# gui/components/control_panel.py
import customtkinter as ctk
import tkinter as tk
from typing import Dict, Any, Optional
from .base_component import BaseGUIComponent

class ControlPanel(BaseGUIComponent):
   """
   Sol taraftaki sistem kontrol paneli
   Sistem modu, ba≈ülat/durdur, acil durdurma gibi kontrolleri i√ßerir
   """
   
   def __init__(self, parent, app_controller):
       super().__init__(parent, app_controller)
       
       # Kontrol deƒüi≈ükenleri
       self.mode_var = tk.StringVar(value="Manuel")
       self.weapon_mode_var = tk.StringVar(value="Otomatik")
       
       # UI elementleri referanslarƒ±
       self.emergency_btn: Optional[ctk.CTkButton] = None
       self.start_btn: Optional[ctk.CTkButton] = None
       self.scan_btn: Optional[ctk.CTkButton] = None
       self.fire_btn: Optional[ctk.CTkButton] = None
       self.mode_menu: Optional[ctk.CTkOptionMenu] = None
       
       # Durum takibi
       self.system_active = False
       self.emergency_active = False
       
       self.setup_ui()
   
   def setup_ui(self) -> None:
       """Kontrol paneli UI'ƒ±nƒ± olu≈ütur"""
       # Ana frame
       self.frame = ctk.CTkFrame(self.parent, width=320, corner_radius=10)
       self.frame.grid(row=0, column=0, sticky="nsw", padx=10, pady=10)
       self.frame.grid_propagate(False)
       
       # Bile≈üenleri olu≈ütur
       self._create_header()
       self._create_mode_selector()
       self._create_emergency_controls()
       self._create_system_controls()
       self._create_weapon_controls()
       self._create_manual_controls()
       self._create_info_section()
   
   def _create_header(self) -> None:
       """Panel ba≈ülƒ±ƒüƒ±nƒ± olu≈ütur"""
       header_frame = ctk.CTkFrame(self.frame, fg_color="transparent")
       header_frame.pack(fill="x", padx=20, pady=(20,10))
       
       title = ctk.CTkLabel(
           header_frame,
           text="üõ°Ô∏è KONTROL PANELƒ∞",
           font=ctk.CTkFont(size=20, weight="bold"),
           text_color=("#ffffff", "#ffffff")
       )
       title.pack()
       
       # Alt ba≈ülƒ±k
       subtitle = ctk.CTkLabel(
           header_frame,
           text="SKY SHIELD v2.0",
           font=ctk.CTkFont(size=12),
           text_color=("#a0a0a0", "#a0a0a0")
       )
       subtitle.pack(pady=(5,0))
   
   def _create_mode_selector(self) -> None:
       """Sistem modu se√ßicisini olu≈ütur"""
       mode_frame = ctk.CTkFrame(self.frame)
       mode_frame.pack(fill="x", padx=20, pady=10)
       
       # Ba≈ülƒ±k
       mode_title = ctk.CTkLabel(
           mode_frame, 
           text="üì° Sistem Modu",
           font=ctk.CTkFont(size=14, weight="bold")
       )
       mode_title.pack(pady=(15,5))
       
       # Mod se√ßici
       self.mode_menu = ctk.CTkOptionMenu(
           mode_frame,
           values=["Manuel", "A≈üama 1", "A≈üama 2", "A≈üama 3"],
           variable=self.mode_var,
           command=self._on_mode_change,
           button_color=("#1f538d", "#14375e"),
           button_hover_color=("#1f538d", "#14375e")
       )
       self.mode_menu.pack(pady=(0,10), padx=15, fill="x")
       
       # Mod a√ßƒ±klamasƒ±
       self.mode_description = ctk.CTkLabel(
           mode_frame,
           text="Manuel kontrol modu aktif",
           font=ctk.CTkFont(size=11),
           text_color=("#808080", "#808080"),
           wraplength=250
       )
       self.mode_description.pack(pady=(0,15), padx=15)
   
   def _create_emergency_controls(self) -> None:
       """Acil durdurma kontrollerini olu≈ütur"""
       emergency_frame = ctk.CTkFrame(self.frame, fg_color="#2d1b1b")
       emergency_frame.pack(fill="x", padx=20, pady=10)
       
       # Acil durdurma butonu
       self.emergency_btn = ctk.CTkButton(
           emergency_frame,
           text="üö® ACƒ∞L DURDUR",
           command=self._emergency_stop,
           fg_color="#dc2626",
           hover_color="#991b1b",
           height=50,
           font=ctk.CTkFont(size=16, weight="bold")
       )
       self.emergency_btn.pack(pady=15, padx=15, fill="x")
       
       # Sistem sƒ±fƒ±rlama butonu
       self.reset_btn = ctk.CTkButton(
           emergency_frame,
           text="üîÑ Sƒ∞STEMƒ∞ SIFIRLA",
           command=self._reset_system,
           fg_color="#d97706",
           hover_color="#92400e",
           height=35,
           font=ctk.CTkFont(size=12)
       )
       self.reset_btn.pack(pady=(0,15), padx=15, fill="x")
   
   def _create_system_controls(self) -> None:
       """Sistem kontrollerini olu≈ütur"""
       controls_frame = ctk.CTkFrame(self.frame)
       controls_frame.pack(fill="x", padx=20, pady=10)
       
       # Ba≈ülƒ±k
       controls_title = ctk.CTkLabel(
           controls_frame,
           text="‚öôÔ∏è Sistem Kontrolleri",
           font=ctk.CTkFont(size=14, weight="bold")
       )
       controls_title.pack(pady=(15,10))
       
       # Ba≈ülat/Durdur butonu
       self.start_btn = ctk.CTkButton(
           controls_frame,
           text="‚ñ∂ Sƒ∞STEMƒ∞ BA≈ûLAT",
           command=self._toggle_system,
           fg_color="#16a34a",
           hover_color="#15803d",
           height=40
       )
       self.start_btn.pack(pady=(0,10), padx=15, fill="x")
       
       # Hedef arama butonu
       self.scan_btn = ctk.CTkButton(
           controls_frame,
           text="üîç HEDEF ARA",
           command=self._start_scan,
           height=35
       )
       self.scan_btn.pack(pady=(0,15), padx=15, fill="x")
   
   def _create_weapon_controls(self) -> None:
       """M√ºhimmat kontrollerini olu≈ütur"""
       weapon_frame = ctk.CTkFrame(self.frame)
       weapon_frame.pack(fill="x", padx=20, pady=10)
       
       # Ba≈ülƒ±k
       weapon_title = ctk.CTkLabel(
           weapon_frame,
           text="üéØ M√ºhimmat Kontrolleri",
           font=ctk.CTkFont(size=14, weight="bold")
       )
       weapon_title.pack(pady=(15,10))
       
       # M√ºhimmat se√ßim modu
       mode_frame = ctk.CTkFrame(weapon_frame, fg_color="transparent")
       mode_frame.pack(fill="x", padx=15, pady=(0,10))
       
       self.weapon_auto_radio = ctk.CTkRadioButton(
           mode_frame,
           text="ü§ñ Otomatik Se√ßim",
           variable=self.weapon_mode_var,
           value="Otomatik",
           command=self._on_weapon_mode_change
       )
       self.weapon_auto_radio.pack(anchor="w", pady=2)
       
       self.weapon_manual_radio = ctk.CTkRadioButton(
           mode_frame,
           text="üë§ Manuel Se√ßim",
           variable=self.weapon_mode_var,
           value="Manuel",
           command=self._on_weapon_mode_change
       )
       self.weapon_manual_radio.pack(anchor="w", pady=2)
       
       # Manuel se√ßim men√ºs√º
       self.manual_weapon_var = tk.StringVar(value="Lazer")
       self.weapon_menu = ctk.CTkOptionMenu(
           weapon_frame,
           values=["Lazer", "Gazlƒ± ƒ∞tki"],
           variable=self.manual_weapon_var,
           command=self._on_manual_weapon_select,
           state="disabled"
       )
       self.weapon_menu.pack(pady=(0,10), padx=15, fill="x")
       
       # Ate≈ü et butonu
       self.fire_btn = ctk.CTkButton(
           weapon_frame,
           text="üéØ ATE≈û ET",
           command=self._fire_weapon,
           fg_color="#dc2626",
           hover_color="#991b1b",
           height=45,
           font=ctk.CTkFont(size=14, weight="bold"),
           state="disabled"
       )
       self.fire_btn.pack(pady=(0,15), padx=15, fill="x")
   
   def _create_manual_controls(self) -> None:
       """Manuel kontrol joystick bilgilerini olu≈ütur"""
       manual_frame = ctk.CTkFrame(self.frame)
       manual_frame.pack(fill="x", padx=20, pady=10)
       
       # Ba≈ülƒ±k
       manual_title = ctk.CTkLabel(
           manual_frame,
           text="üïπÔ∏è Manuel Kontrol",
           font=ctk.CTkFont(size=14, weight="bold")
       )
       manual_title.pack(pady=(15,10))
       
       # Joystick durumu
       self.joystick_status = ctk.CTkLabel(
           manual_frame,
           text="üî¥ Joystick: Baƒülƒ± Deƒüil",
           font=ctk.CTkFont(size=12)
       )
       self.joystick_status.pack(pady=(0,10), padx=15)
       
       # Joystick kalibrasyonu
       self.calibrate_btn = ctk.CTkButton(
           manual_frame,
           text="‚öôÔ∏è Kalibrasyon",
           command=self._calibrate_joystick,
           height=30,
           font=ctk.CTkFont(size=11)
       )
       self.calibrate_btn.pack(pady=(0,15), padx=15, fill="x")
   
   def _create_info_section(self) -> None:
       """Bilgi b√∂l√ºm√ºn√º olu≈ütur"""
       info_frame = ctk.CTkFrame(self.frame)
       info_frame.pack(fill="both", expand=True, padx=20, pady=(10,20))
       
       # Ba≈ülƒ±k
       info_title = ctk.CTkLabel(
           info_frame,
           text="‚ÑπÔ∏è Sistem Bilgileri",
           font=ctk.CTkFont(size=14, weight="bold")
       )
       info_title.pack(pady=(15,10))
       
       # Bilgi grid'i
       info_grid = ctk.CTkFrame(info_frame, fg_color="transparent")
       info_grid.pack(fill="x", padx=15, pady=(0,15))
       
       # CPU kullanƒ±mƒ±
       cpu_frame = ctk.CTkFrame(info_grid)
       cpu_frame.pack(fill="x", pady=2)
       
       ctk.CTkLabel(cpu_frame, text="CPU:", anchor="w").pack(side="left", padx=(10,5))
       self.cpu_label = ctk.CTkLabel(cpu_frame, text="0%", anchor="e")
       self.cpu_label.pack(side="right", padx=(5,10))
       
       # Bellek kullanƒ±mƒ±
       ram_frame = ctk.CTkFrame(info_grid)
       ram_frame.pack(fill="x", pady=2)
       
       ctk.CTkLabel(ram_frame, text="RAM:", anchor="w").pack(side="left", padx=(10,5))
       self.ram_label = ctk.CTkLabel(ram_frame, text="0 MB", anchor="e")
       self.ram_label.pack(side="right", padx=(5,10))
       
       # Sƒ±caklƒ±k
       temp_frame = ctk.CTkFrame(info_grid)
       temp_frame.pack(fill="x", pady=2)
       
       ctk.CTkLabel(temp_frame, text="Sƒ±caklƒ±k:", anchor="w").pack(side="left", padx=(10,5))
       self.temp_label = ctk.CTkLabel(temp_frame, text="--¬∞C", anchor="e")
       self.temp_label.pack(side="right", padx=(5,10))
   
   # Event handler'lar
   def _on_mode_change(self, value: str) -> None:
       """Mod deƒüi≈ütiƒüinde √ßaƒürƒ±lƒ±r"""
       mode_map = {"Manuel": 0, "A≈üama 1": 1, "A≈üama 2": 2, "A≈üama 3": 3}
       mode_descriptions = {
           "Manuel": "Operat√∂r joystick ile kontrol eder",
           "A≈üama 1": "T√ºm hareketli hedefler otomatik imha edilir",
           "A≈üama 2": "Dost-d√º≈üman ayrƒ±mƒ± yapƒ±larak imha edilir",
           "A≈üama 3": "Angajman emri ile belirli hedefler imha edilir"
       }
       
       # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
       if self.app:
           self.app.send_command("change_mode", mode_map[value])
       
       self.mode_description.configure(text=mode_descriptions[value])
       
       # Manuel mod kontrollerini g√ºncelle
       if value == "Manuel":
           self._enable_manual_controls()
       else:
           self._disable_manual_controls()
   
   def _emergency_stop(self) -> None:
       """Acil durdurma i≈ülemi"""
       # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
       if self.app:
           self.app.send_command("emergency_stop")
       
       self.emergency_active = True
       
       # UI g√ºncellemeleri
       self.emergency_btn.configure(
           text="‚èπ DURDURULDU",
           state="disabled",
           fg_color="#991b1b"
       )
       self.start_btn.configure(
           text="‚ñ∂ Sƒ∞STEMƒ∞ BA≈ûLAT",
           fg_color="#16a34a",
           state="disabled"
       )
       self._disable_all_controls()
   
   def _reset_system(self) -> None:
       """Sistemi sƒ±fƒ±rla"""
       # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
       if self.app:
           self.app.send_command("reset_system")
       
       self.emergency_active = False
       self.system_active = False
       
       # UI'yi sƒ±fƒ±rla
       self.emergency_btn.configure(
           text="üö® ACƒ∞L DURDUR",
           state="normal",
           fg_color="#dc2626"
       )
       self.start_btn.configure(
           text="‚ñ∂ Sƒ∞STEMƒ∞ BA≈ûLAT",
           fg_color="#16a34a",
           state="normal"
       )
       self._enable_all_controls()
   
   def _toggle_system(self) -> None:
       """Sistemi ba≈ülat/durdur"""
       if self.system_active:
           # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
           if self.app:
               self.app.send_command("stop_system")
           
           self.system_active = False
           self.start_btn.configure(
               text="‚ñ∂ Sƒ∞STEMƒ∞ BA≈ûLAT",
               fg_color="#16a34a"
           )
           self.scan_btn.configure(state="disabled")
       else:
           # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
           if self.app:
               self.app.send_command("start_system")
           
           self.system_active = True
           self.start_btn.configure(
               text="‚è∏ Sƒ∞STEMƒ∞ DURDUR",
               fg_color="#dc2626"
           )
           self.scan_btn.configure(state="normal")
   
   def _start_scan(self) -> None:
       """Hedef arama ba≈ülat"""
       if self.system_active:
           # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
           if self.app:
               self.app.send_command("start_scan")
           
           self.scan_btn.configure(
               text="üîÑ ARANIYOR...",
               state="disabled"
           )
   
   def _on_weapon_mode_change(self) -> None:
       """M√ºhimmat modu deƒüi≈ütiƒüinde"""
       if self.weapon_mode_var.get() == "Manuel":
           self.weapon_menu.configure(state="normal")
       else:
           self.weapon_menu.configure(state="disabled")
       
       # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
       if self.app:
           self.app.send_command("weapon_mode_change", self.weapon_mode_var.get())
   
   def _on_manual_weapon_select(self, value: str) -> None:
       """Manuel m√ºhimmat se√ßimi"""
       # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
       if self.app:
           self.app.send_command("select_weapon", value)
   
   def _fire_weapon(self) -> None:
       """Ate≈ü et"""
       # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
       if self.app:
           self.app.send_command("fire_weapon")
       
       self.fire_btn.configure(
           text="üî• ATE≈ûLENIYOR...",
           state="disabled"
       )
   
   def _calibrate_joystick(self) -> None:
       """Joystick kalibrasyonu"""
       # APP CONTROLLER ƒ∞LE KOMUT G√ñNDER - D√úZELTME
       if self.app:
           self.app.send_command("calibrate_joystick")
       
       self.calibrate_btn.configure(text="‚è≥ Kalibrasyon...")
   
   def _enable_manual_controls(self) -> None:
       """Manuel kontrolleri etkinle≈ütir"""
       self.calibrate_btn.configure(state="normal")
       self.joystick_status.configure(text="üü° Joystick: Manuel Mod")
   
   def _disable_manual_controls(self) -> None:
       """Manuel kontrolleri devre dƒ±≈üƒ± bƒ±rak"""
       self.calibrate_btn.configure(state="disabled")
       self.joystick_status.configure(text="üü¢ Joystick: Otomatik Mod")
   
   def _enable_all_controls(self) -> None:
       """T√ºm kontrolleri etkinle≈ütir"""
       widgets = [self.mode_menu, self.start_btn, self.scan_btn]
       for widget in widgets:
           if widget:
               widget.configure(state="normal")
   
   def _disable_all_controls(self) -> None:
       """T√ºm kontrolleri devre dƒ±≈üƒ± bƒ±rak"""
       widgets = [self.mode_menu, self.scan_btn, self.fire_btn]
       for widget in widgets:
           if widget:
               widget.configure(state="disabled")
   
   def update_data(self, data: Dict[str, Any]) -> None:
       """Kontrol paneli verilerini g√ºncelle"""
       # Hedef kilidi durumu
       if data.get('target_locked'):
           self.fire_btn.configure(state="normal")
           self.scan_btn.configure(
               text="üîí HEDEF Kƒ∞Lƒ∞TLƒ∞",
               state="disabled"
           )
       else:
           if not self.emergency_active:
               self.fire_btn.configure(state="disabled")
               if self.system_active:
                   self.scan_btn.configure(
                       text="üîç HEDEF ARA",
                       state="normal"
                   )
       
       # Sistem durumu
       if not data.get('active') and self.system_active:
           self.system_active = False
           self.start_btn.configure(
               text="‚ñ∂ Sƒ∞STEMƒ∞ BA≈ûLAT",
               fg_color="#16a34a"
           )
       
       # Ate≈ü durumu sƒ±fƒ±rlama
       if self.fire_btn.cget("text") == "üî• ATE≈ûLENIYOR...":
           self.fire_btn.configure(text="üéØ ATE≈û ET")
       
       # Sistem bilgileri g√ºncelle
       if 'cpu_usage' in data:
           self.cpu_label.configure(text=f"{data['cpu_usage']:.1f}%")
       if 'ram_usage' in data:
           self.ram_label.configure(text=f"{data['ram_usage']:.0f} MB")
       if 'temperature' in data:
           self.temp_label.configure(text=f"{data['temperature']:.1f}¬∞C")
   
   def get_data(self) -> Dict[str, Any]:
       """Kontrol paneli verilerini d√∂nd√ºr"""
       return {
           'mode': self.mode_var.get(),
           'weapon_mode': self.weapon_mode_var.get(),
           'manual_weapon': self.manual_weapon_var.get(),
           'system_active': self.system_active,
           'emergency_active': self.emergency_active
       }
   
   def reset(self) -> None:
       """Kontrol panelini sƒ±fƒ±rla"""
       self.mode_var.set("Manuel")
       self.weapon_mode_var.set("Otomatik")
       self.manual_weapon_var.set("Lazer")
       self.system_active = False
       self.emergency_active = False
       
       # Butonlarƒ± sƒ±fƒ±rla
       if self.emergency_btn:
           self.emergency_btn.configure(
               text="üö® ACƒ∞L DURDUR",
               state="normal",
               fg_color="#dc2626"
           )
       if self.start_btn:
           self.start_btn.configure(
               text="‚ñ∂ Sƒ∞STEMƒ∞ BA≈ûLAT",
               fg_color="#16a34a"
           )
       if self.scan_btn:
           self.scan_btn.configure(
               text="üîç HEDEF ARA",
               state="disabled"
           )
       if self.fire_btn:
           self.fire_btn.configure(
               text="üéØ ATE≈û ET",
               state="disabled"
           )